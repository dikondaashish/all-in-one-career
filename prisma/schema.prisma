// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id            String   @id @default(cuid())
  email        String   @unique
  name         String?
  profileImage String?  // URL to user's profile photo
  theme        Theme?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Usage metrics
  portfolios    Int      @default(0)
  emails        Int      @default(0)
  referrals     Int      @default(0)
  trackerEvents Int      @default(0)

  applications      Application[]
  referralRequests ReferralRequest[]
  portfolioSites   PortfolioSite[]
  logs             Log[]
  searchHistory    SearchHistory[]
  notifications    Notification[]
  atsScans         AtsScan[]
  atsScansAdvanced AtsScanAdvanced[]
  atsScansV2       AtsScanV2[]
  savedResumes     SavedResume[]
  atsPreferences   AtsUserPreference[]
  ocrJobs          OcrJob[]
}

model JobDescription {
  id        String   @id @default(cuid())
  title     String
  company   String
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  applications Application[]
}

model Application {
  id        String   @id @default(cuid())
  userId    String
  company   String
  role      String
  status    ApplicationStatus @default(SAVED)
  jdId      String?
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User           @relation(fields: [userId], references: [id])
  jd   JobDescription? @relation(fields: [jdId], references: [id])
}

model ReferralRequest {
  id          String   @id @default(cuid())
  fromUserId  String
  toEmployee  String
  company     String
  role        String
  status      ReferralStatus @default(PENDING)
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [fromUserId], references: [id])
}

model PortfolioSite {
  id        String   @id @default(cuid())
  userId    String
  slug      String   @unique
  theme     String
  data      Json
  url       String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model SearchHistory {
  id        String   @id @default(cuid())
  query     String
  answer    String?
  userId    String?
  createdAt DateTime @default(now())
  
  user User? @relation(fields: [userId], references: [id])
}

enum ApplicationStatus {
  SAVED
  APPLIED
  INTERVIEW
  OFFER
  REJECTED
}

enum ReferralStatus {
  PENDING
  APPROVED
  REJECTED
}

model Log {
  id        String   @id @default(cuid())
  userId    String
  action    String
  message   String?
  createdAt DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id])
}

model Notification {
  id         String   @id @default(cuid())
  userId     String
  type       String   // FEATURE | SYSTEM | TASK | PROMOTION
  title      String
  message    String
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())
  archived   Boolean  @default(false)
  
  user User @relation(fields: [userId], references: [id])
}



enum Theme {
  LIGHT
  DARK
  SYSTEM
}

// ATS Scanner Models
model AtsScan {
  id                    String   @id @default(cuid())
  userId                String
  resumeText            String
  resumeFilename        String?
  resumeFileUrl         String?
  jobDescription        String
  jobTitle              String?
  companyName           String?
  overallScore          Int?
  matchRate             Int?
  searchabilityScore    Int?
  atsCompatibilityScore Int?
  detailedAnalysis      Json?
  missingKeywords       Json?
  foundKeywords         Json?
  recruiterTips         Json?
  improvementSuggestions Json?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
  ocrJobs OcrJob[]
  atsScansV2 AtsScanV2[] // v2 scans that reference this v1 scan
}

model SavedResume {
  id         String   @id @default(cuid())
  userId     String
  resumeName String
  resumeText String?
  fileUrl    String?
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

model AtsUserPreference {
  id                   String   @id @default(cuid())
  userId               String   @unique
  autoSaveResumes      Boolean  @default(false)
  defaultIndustry      String?
  notificationSettings Json?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model OcrJob {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  scanId          String?  // optional link to ats_scans row
  scan            AtsScan? @relation(fields: [scanId], references: [id], onDelete: SetNull)
  s3Key           String
  status          String   // queued | running | succeeded | failed
  textractJobId   String?
  extractedText   String?
  error           String?
  filename        String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([s3Key])
  @@index([status])
}

// Advanced ATS Scanner Models
model AtsScanAdvanced {
  id                   String   @id @default(cuid())
  userId               String
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Basic scores (existing)
  overallScore         Int
  matchRate           Int
  searchability       Int
  atsCompatibility    Int
  
  // NEW: Advanced Intelligence
  skillRelevancy      Json     // RevolutionaryScoring.skillRelevancy
  careerTrajectory    Json     // RevolutionaryScoring.careerTrajectory
  impactScore         Json     // RevolutionaryScoring.impactScore
  recruiterAppeal     Json     // RevolutionaryScoring.recruiterAppeal
  redFlags            Json     // RevolutionaryScoring.redFlags
  
  // NEW: Industry Intelligence
  industryDetection   Json     // IndustryIntelligence.industryDetection
  industryScoring     Json     // IndustryIntelligence.industrySpecificScoring
  
  // NEW: Predictions
  hireProbability     Json     // HireProbabilityResult
  interviewReadiness  Json     // Interview prediction data
  salaryNegotiation   Json     // Salary insights
  
  // NEW: Market Intelligence
  marketPosition      Json     // Competitive analysis
  skillDemand         Json     // Current market demand for skills
  
  // Existing fields
  detailedAnalysis    Json?
  hardSkillsFound     Json?
  hardSkillsMissing   Json?
  recruiterTips       Json?
  keywordAnalysis     Json?
  improvementSuggestions Json?
  
  // Original content for reference
  resumeText          String
  jobDescription      String
  companyName         String?
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@map("ats_scans_advanced")
}

model MarketIntelligence {
  id              String   @id @default(cuid())
  industry        String
  skillDemand     Json     // Current demand levels for skills
  salaryTrends    Json     // Salary trend data
  hiringTrends    Json     // Hiring volume and patterns
  lastUpdated     DateTime @default(now())
  
  @@map("market_intelligence")
}

model CompanyProfiles {
  id              String   @id @default(cuid())
  companyName     String   @unique
  domain          String?
  industry        String
  size            String
  cultureKeywords Json     // Company culture indicators
  techStack       Json     // Preferred technologies
  hiringPatterns  Json     // Historical hiring data
  averageTenure   Float?
  lastUpdated     DateTime @default(now())
  
  @@map("company_profiles")
}

// ATS Scanner V2 - Enhanced Foundational Features (Additive)
model AtsScanV2 {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  scanV1Id        String?  // optional link to existing v1 scan
  scanV1          AtsScan? @relation(fields: [scanV1Id], references: [id], onDelete: SetNull)
  
  // Core ATS foundational checks
  atsChecks       Json     // fileType, fileName, contact, sections, dates, wordCount, jobTitleMatch
  
  // Enhanced skills analysis
  skillsSplit     Json     // hard/soft/transferable skills with impact weights
  
  // Recruiter psychology insights
  recruiterPsych  Json     // 6-second impression, authority language, narrative coherence, red flags, badges
  
  // Industry and market intelligence  
  industryJson    Json     // detected industry, trending/declining skills, career paths, market percentile
  marketJson      Json     // skill demand heatmap, market positioning data
  
  // Company-specific optimization (nullable if no company data)
  companyOpt      Json?    // culture alignment, tech stack match, background fit, optimization recommendations
  
    // Enhanced predictions with bands and X-factor
  predictiveV2    Json     // hire probability bands, X-factor, automation risk, enhanced interview readiness, salary bands

  // V2 Scoring System (additive)
  overallScoreV2  Json?    // {overall, band, confidence, breakdown, meta}
  subscoresV2     Json?    // SubScores object with all A1-A9, B1-B5, C1-C3, D1-D3, E1-E2

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("ats_scans_v2")
}


